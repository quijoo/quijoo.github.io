<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>[游戏机制] 里世界-优化 - Quijo&#39;s blog</title><meta name="Description" content=""><meta property="og:title" content="[游戏机制] 里世界-优化" />
<meta property="og:description" content="在之前的文章里提到过 里世界机制 游戏机制，但是最初的版本是需要手动用右摇杆移动 &ldquo;透镜&rdquo; 来观察里世界的物体，这样的设计有" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" /><meta property="og:image" content="http://blog.xuaii.cc/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-03T18:37:43+08:00" />
<meta property="article:modified_time" content="2023-01-08T07:03:59+08:00" /><meta property="og:site_name" content="我的网站" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://blog.xuaii.cc/logo.png"/>

<meta name="twitter:title" content="[游戏机制] 里世界-优化"/>
<meta name="twitter:description" content="在之前的文章里提到过 里世界机制 游戏机制，但是最初的版本是需要手动用右摇杆移动 &ldquo;透镜&rdquo; 来观察里世界的物体，这样的设计有"/>
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" /><link rel="prev" href="http://blog.xuaii.cc/you-xi-ji-zhi-chuang-ti-hu-dong/" /><link rel="next" href="http://blog.xuaii.cc/you-xi-wai-gua-ai-zi-miao/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "[游戏机制] 里世界-优化",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/blog.xuaii.cc\/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua\/"
        },"genre": "posts","wordcount":  2763 ,
        "url": "http:\/\/blog.xuaii.cc\/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua\/","datePublished": "2023-01-03T18:37:43+08:00","dateModified": "2023-01-08T07:03:59+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "_quijo"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Quijo&#39;s blog">Quijolient</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/record/"> 记录 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Quijo&#39;s blog">Quijolient</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/record/" title="">记录</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[游戏机制] 里世界-优化</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="blog.xuii.cc" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>_quijo</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-01-03">2023-01-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;2763 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="true">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#光照剔除">光照剔除</a></li>
        <li><a href="#动态碰撞体">动态碰撞体</a></li>
        <li><a href="#推箱子">推箱子</a></li>
        <li><a href="#美化---添加进出口特效">美化 - 添加进出口特效</a></li>
        <li><a href="#一些思考核问题">一些思考核问题</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>在之前的文章里提到过 <a href="https://www.bilibili.com/video/BV1Er4y1t7NK?spm_id_from=333.999.0.0&amp;vd_source=f793394b2f7b2b82cc3f09ecd0d4cd91" target="_blank" rel="noopener noreffer ">里世界机制</a> 游戏机制，但是最初的版本是需要手动用右摇杆移动 &ldquo;透镜&rdquo; 来观察里世界的物体，这样的设计有以下几个<strong>缺陷</strong>：</p>
<ol>
<li>需要控制左右摇杆和跳跃键来控制人物和移动 &ldquo;透镜&rdquo;</li>
<li>透镜 <strong>自由度过高</strong>，限制了关卡设计的可能性</li>
<li>仅仅实现了遮挡 / 显示 物体，并没有修改物体的<strong>碰撞体积</strong></li>
</ol>
<p>后来玩到 <a href="https://zelda.fandom.com/zh/wiki/%E5%A1%9E%E5%B0%94%E8%BE%BE%E4%BC%A0%E8%AF%B4%EF%BC%9A%E4%BC%97%E7%A5%9E%E7%9A%84%E4%B8%89%E8%A7%92%E5%8A%9B%E9%87%8F2" target="_blank" rel="noopener noreffer ">《塞尔达传说三角力量 2》</a> ，其中林克化身壁画在墙壁游走的能力给了我很大的启发：&ldquo;壁画林克只能在一条水平线上移动，而作者利用地形的高低差设计了很多意想不到的关卡&rdquo;, 这背后的思考是 &ldquo;通过限制玩家的能力，来增加关卡设计的可能性&rdquo;，回到里世界机制上，我们可以通过限制&quot;透镜&quot;的移动和玩家进入的方式来增加关卡设计的可能性：
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://xuaii.github.io/post-images/1662048022127.gif"
        data-srcset="https://xuaii.github.io/post-images/1662048022127.gif, https://xuaii.github.io/post-images/1662048022127.gif 1.5x, https://xuaii.github.io/post-images/1662048022127.gif 2x"
        data-sizes="auto"
        alt="https://xuaii.github.io/post-images/1662048022127.gif"
        title="https://xuaii.github.io/post-images/1662048022127.gif" />
于是，我对机制进行如下修正:</p>
<ol>
<li>通过<strong>推箱子</strong>的形式移动透镜，而不是用<strong>右摇杆</strong></li>
<li>限制透镜的<strong>进入点</strong>，而不是<strong>全开放</strong></li>
</ol>
<p>这样的修正可以以某种方式设计关卡，让玩家思考以何种顺序移动各个箱子能到达想要去的目标，它的本质是<strong>推箱子</strong>， 只是换上了一层 <strong>里世界</strong> 的皮</p>
<p>下面来构思整个机制的实现：</p>
<ol>
<li>实现 &ldquo;透镜&rdquo; 内的物体不显示, 之外的物体显示 -&gt; 使用光照剔除</li>
<li>实现 &ldquo;透镜&rdquo; 内的物体与玩家碰撞，之外的物体不碰撞 -&gt; 使用 PolygenShape动态修改</li>
<li>实现 推箱子 机制 -&gt; 箱子内和箱子都能推动（避免死锁）</li>
</ol>
<h3 id="光照剔除">光照剔除</h3>
<p>在之前的实现里，将里世界的所有物体放入一个单独的 CanvasLayer，再应用一个 CanvasModulate 将不透明度设置为 0， 然后用一一个 Light2D 来为里世界物体添加 透明度，这样实现玩家不能与里世界物体发生物理交互所以采用了很复杂的实现方式。</p>
<p>Godot Light2D 有一个 Mask 模式专门用于剔除物体，被剔除的物体需要确保</p>
<ol>
<li>层号在 (layer_min, layer_max) 之间</li>
<li>光照层在 Item Cull Mask 之中</li>
</ol>
<p>使用一个 Texture 与透镜大小相同的 Light2D 节点， 选择 Add / Mix 模式位被剔除的物体赋予颜色，同样需要确保光照层和画布层设置正确</p>
<p>此外，可以通过 WorldEnviroment 节点为里世界的物体增加荧光，或者设置边缘光 Shader 增加区分度。</p>
<h3 id="动态碰撞体">动态碰撞体</h3>
<p>动态碰撞体很简单，只需要每帧取碰撞体矩形 DefaultRect 透镜碰撞体矩形 LensRect，计算两个 Rect2 的 ∩ 即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">LensRect</span> <span class="p">:</span> <span class="n">Area2D</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Godot</span><span class="p">.</span><span class="n">Object</span><span class="p">&gt;</span> <span class="n">NearbyLens</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">Godot</span><span class="p">.</span><span class="n">Object</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector2</span> <span class="n">extent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CollisionShape2D</span> <span class="n">shape</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_Ready</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">shape</span> <span class="p">=</span> <span class="n">GetNode</span><span class="p">&lt;</span><span class="n">CollisionShape2D</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">CollisionShape2D</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">extent</span> <span class="p">=</span> <span class="p">(</span><span class="n">shape</span><span class="p">.</span><span class="n">Shape</span> <span class="k">as</span> <span class="n">RectangleShape2D</span><span class="p">).</span><span class="n">Extents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Called every frame. &#39;delta&#39; is the elapsed time since the previous frame.</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_PhysicsProcess</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span><span class="p">(</span><span class="n">DynamicPolygon</span> <span class="n">polygon</span> <span class="k">in</span> <span class="n">NearbyLens</span><span class="p">.</span><span class="n">Values</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">polygon</span><span class="p">.</span><span class="n">Clips</span><span class="p">(</span><span class="n">ToGlobal</span><span class="p">(</span><span class="n">shape</span><span class="p">.</span><span class="n">Position</span> <span class="p">-</span> <span class="n">extent</span><span class="p">),</span> <span class="n">ToGlobal</span><span class="p">(</span><span class="n">shape</span><span class="p">.</span><span class="n">Position</span> <span class="p">+</span> <span class="n">extent</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">_on_LensRect_area_entered</span><span class="p">(</span><span class="n">Area2D</span> <span class="n">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">parent</span> <span class="p">=</span> <span class="n">body</span><span class="p">.</span><span class="n">GetParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">parent</span> <span class="k">is</span> <span class="n">DynamicPolygon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">NearbyLens</span><span class="p">[</span><span class="n">parent</span><span class="p">.</span><span class="n">Name</span><span class="p">]</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">_on_LensRect_area_exited</span><span class="p">(</span><span class="n">Area2D</span> <span class="n">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Node</span> <span class="n">parent</span> <span class="p">=</span> <span class="n">body</span><span class="p">.</span><span class="n">GetParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">parent</span> <span class="k">is</span> <span class="n">DynamicPolygon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">NearbyLens</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Lens 需要使用一个 Area2D 记录附近可能相交的<strong>里世界物体</strong>，在每一个物理帧调用 <code>polygon.Clips()</code> 更新附近<strong>里世界物体</strong>的多边形点集</p>
<p>对于每一个里世界物体， 只需实现 Clips 方法， 并保证碰撞体附近没有 Lens 时，碰撞体保持休眠状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">DynamicPolygon</span> <span class="p">:</span> <span class="n">KinematicBody2D</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">private</span> <span class="n">CollisionPolygon2D</span> <span class="n">shape</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">private</span> <span class="n">Rect2</span> <span class="n">rect</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_Ready</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Sprite</span> <span class="n">sprite</span> <span class="p">=</span> <span class="n">GetNode</span><span class="p">&lt;</span><span class="n">Sprite</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Sprite</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">shape</span> <span class="p">=</span> <span class="n">GetNode</span><span class="p">&lt;</span><span class="n">CollisionPolygon2D</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">CollisionPolygon2D</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">rect</span> <span class="p">=</span> <span class="n">sprite</span><span class="p">.</span><span class="n">GetRect</span><span class="p">();</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Called every frame. &#39;delta&#39; is the elapsed time since the previous frame.</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">void</span> <span class="n">Clips</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">p1</span><span class="p">,</span> <span class="n">Vector2</span> <span class="n">p2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Rect2</span> <span class="n">_rect</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Rect2</span><span class="p">(</span><span class="n">ToLocal</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="n">ToLocal</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="p">-</span> <span class="n">ToLocal</span><span class="p">(</span><span class="n">p1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">Rect2</span> <span class="n">inter</span> <span class="p">=</span> <span class="n">rect</span><span class="p">.</span><span class="n">Clip</span><span class="p">(</span><span class="n">_rect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Vector2</span> <span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">Vector2</span> <span class="n">local</span> <span class="p">=</span> <span class="n">inter</span><span class="p">.</span><span class="n">Position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">array</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">local</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">array</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="n">local</span> <span class="p">+</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Right</span> <span class="p">*</span> <span class="n">inter</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">array</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="n">local</span> <span class="p">+</span> <span class="n">inter</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">array</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="n">local</span> <span class="p">+</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Down</span> <span class="p">*</span> <span class="n">inter</span><span class="p">.</span><span class="n">Size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">shape</span><span class="p">.</span><span class="n">Polygon</span> <span class="p">=</span> <span class="n">array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">void</span> <span class="n">_on_Area2D_area_entered</span><span class="p">(</span><span class="n">Area2D</span> <span class="n">area</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="k">is</span> <span class="n">LensRect</span> <span class="n">magic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">shape</span><span class="p">.</span><span class="n">SetDeferred</span><span class="p">(</span><span class="s">&#34;disabled&#34;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">_on_Area2D_area_exited</span><span class="p">(</span><span class="n">Area2D</span> <span class="n">area</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="k">is</span> <span class="n">LensRect</span> <span class="n">magic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">shape</span><span class="p">.</span><span class="n">SetDeferred</span><span class="p">(</span><span class="s">&#34;disabled&#34;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个地方有很多可以优化的点（下次一定），例如：</p>
<ol>
<li>
<p>目前仅支持 矩形 Lens 和 矩形里世界物体，可以考虑支持任意多边形</p>
</li>
<li>
<p>可以优化同时对 <strong>多个Lens</strong>， <strong>多个 里世界物体</strong> 更新（例如使用 ECS， 做一个 System 统一更新，效率更高，也可以做一些向量优化，maybe）</p>
</li>
<li>
<p>实现 其他 PhysicsBody 的里世界物体</p>
</li>
<li>
<p>添加 [Tool]编辑器代码，方便 Debug</p>
</li>
</ol>
<h3 id="推箱子">推箱子</h3>
<p>首先实现<strong>箱子类</strong>，他是一个可推动接口，实现 Push 和Stop方法, 受到重力影响</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">interface</span> <span class="nc">IPushable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Push</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">direction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">TestMovableCube</span> <span class="p">:</span> <span class="n">KinematicBody2D</span><span class="p">,</span> <span class="n">IPushable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">Vector2</span> <span class="n">_velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Export]</span> <span class="k">private</span> <span class="kt">float</span> <span class="n">_pushSpeed</span> <span class="p">=</span> <span class="m">100f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_PhysicsProcess</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_velocity</span> <span class="p">+=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Down</span> <span class="p">*</span> <span class="m">100f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_velocity</span> <span class="p">=</span> <span class="n">MoveAndSlide</span><span class="p">(</span><span class="n">_velocity</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">void</span> <span class="n">Push</span><span class="p">(</span><span class="n">Vector2</span> <span class="n">direction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="n">_velocity</span> <span class="p">+=</span> <span class="n">_pushSpeed</span> <span class="p">*</span> <span class="n">direction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">void</span> <span class="n">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_velocity</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其次是 玩家/怪物的Push状态, 这里在每一帧计算<strong>正在推动的物体列表</strong>， 然后每帧调用IPushable.Push() 方法，每帧开始时和退出状态时需要将所有正在推动的物体停下来（否则将做匀速直线运动）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    状态有四个生命周期, 进入, 更新， 物理更新， 退出
</span></span></span><span class="line"><span class="cl"><span class="cm">    有 Init 接口函数用于初始化，有 Exit() 方法用于退出当前状态
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Push</span> <span class="p">:</span> <span class="n">StateBase</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">Player</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IPushable</span><span class="p">&gt;</span> <span class="n">cacheCubes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IPushable</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnEnter</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="p">=</span> <span class="n">agent</span> <span class="k">as</span> <span class="n">Player</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">GD</span><span class="p">.</span><span class="n">Print</span><span class="p">(</span><span class="s">&#34;Enter &#34;</span><span class="p">,</span> <span class="n">StateName</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">Update</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">PhysicsUpdate</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">GravityHandler</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">DefaultGravity</span><span class="p">.</span><span class="n">JumpGravity</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">GestureHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">HorizontalHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">SnapHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cube</span> <span class="k">in</span> <span class="n">cacheCubes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cube</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cacheCubes</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">target</span><span class="p">.</span><span class="n">GetSlideCount</span><span class="p">();</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// tips: Godot.Collections.Array dont support the c# interface</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">collision</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetSlideCollision</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">Collider</span> <span class="k">is</span> <span class="n">IPushable</span> <span class="n">pushable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">GD</span><span class="p">.</span><span class="n">Print</span><span class="p">(</span><span class="n">collision</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">cacheCubes</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pushable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">pushable</span><span class="p">.</span><span class="n">Push</span><span class="p">(-</span><span class="n">collision</span><span class="p">.</span><span class="n">Normal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((!</span><span class="n">Input</span><span class="p">.</span><span class="n">IsActionPressed</span><span class="p">(</span><span class="s">&#34;ui_left&#34;</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">Input</span><span class="p">.</span><span class="n">IsActionPressed</span><span class="p">(</span><span class="s">&#34;ui_right&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">||</span> <span class="n">target</span><span class="p">.</span><span class="n">JumpRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">||</span> <span class="p">!</span><span class="n">target</span><span class="p">.</span><span class="n">IsOnFloor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Exit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnExit</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cube</span> <span class="k">in</span> <span class="n">cacheCubes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">cube</span><span class="p">.</span><span class="n">Stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">GD</span><span class="p">.</span><span class="n">Print</span><span class="p">(</span><span class="s">&#34;Exit &#34;</span><span class="p">,</span> <span class="n">StateName</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tips: 这里<strong>为什么不让物体自己动</strong>? 而是要推动者维护一个推动列表呢？如果 IPushable 自己动，即使 <strong>Player 紧贴着 IPushable推动</strong>，IPushable仍然<strong>不能在每帧检测到有 Player 正在推它</strong>，这会导致 IPushable 移动时断断续续的（不清楚这是bug还是特性)</p>
<h3 id="美化---添加进出口特效">美化 - 添加进出口特效</h3>
<p>由于这本来是一个原型项目，所以只实现见简单特效即可（主要是花里胡哨的我也不会），Lens的进出口使用激光门（就是两束激光）</p>
<p><strong>激光实现</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="p">-</span> <span class="n">RayCast2D</span>
</span></span><span class="line"><span class="cl">    <span class="p">-</span> <span class="n">Position2D</span>
</span></span><span class="line"><span class="cl">        <span class="p">-</span> <span class="n">Sprite</span>
</span></span><span class="line"><span class="cl">    <span class="p">-</span> <span class="n">CPUParticals2D</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="na">[Tool]</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">class</span> <span class="nc">Laser</span> <span class="p">:</span> <span class="n">RayCast2D</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Sprite</span> <span class="n">sprite</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Position2D</span> <span class="n">anchor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">default_length</span> <span class="p">=</span> <span class="m">580f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Vector2</span> <span class="n">target</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Right</span><span class="p">*</span><span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CPUParticles2D</span> <span class="n">articles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_Ready</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">anchor</span> <span class="p">=</span> <span class="n">GetNode</span><span class="p">&lt;</span><span class="n">Position2D</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Position2D</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">sprite</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">GetNode</span><span class="p">&lt;</span><span class="n">Sprite</span><span class="p">&gt;(</span><span class="n">nameof</span><span class="p">(</span><span class="n">Sprite</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">Enabled</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">articles</span> <span class="p">=</span> <span class="n">GetNode</span><span class="p">&lt;</span><span class="n">CPUParticles2D</span><span class="p">&gt;(</span><span class="s">&#34;LaserPartical&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Scale</span> <span class="p">=</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">One</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//  // Called every frame. &#39;delta&#39; is the elapsed time since the previous frame.</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="n">_PhysicsProcess</span><span class="p">(</span><span class="kt">float</span> <span class="n">delta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">anchor</span><span class="p">.</span><span class="n">Rotation</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">Position</span><span class="p">.</span><span class="n">AngleToPoint</span><span class="p">(</span><span class="n">CastTo</span><span class="p">)</span> <span class="p">+</span> <span class="n">Mathf</span><span class="p">.</span><span class="n">Pi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">dis</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">Engine</span><span class="p">.</span><span class="n">EditorHint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">IsColliding</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">target</span> <span class="p">=</span> <span class="n">GetCollisionPoint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">articles</span><span class="p">.</span><span class="n">GlobalPosition</span> <span class="p">=</span> <span class="n">GetCollisionPoint</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">articles</span><span class="p">.</span><span class="n">Direction</span> <span class="p">=</span> <span class="n">GetCollisionNormal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">articles</span><span class="p">.</span><span class="n">Emitting</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                <span class="n">articles</span><span class="p">.</span><span class="n">Emitting</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">dis</span> <span class="p">=</span> <span class="n">ToLocal</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="n">Length</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="n">dis</span> <span class="p">=</span> <span class="n">CastTo</span><span class="p">.</span><span class="n">Length</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">anchor</span><span class="p">.</span><span class="n">Scale</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Vector2</span><span class="p">(</span><span class="n">dis</span> <span class="p">/</span> <span class="n">default_length</span><span class="p">,</span> <span class="n">anchor</span><span class="p">.</span><span class="n">Scale</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>激光使用了<a href="https://godotshaders.com/shader/energy-beams/" target="_blank" rel="noopener noreffer ">Energy Beams - Godot Shaders</a> 的实现， 使用一个 Texture 表示一个激光，这种做法可以使用Shader 计算扰动，但是对于本题这种点到点激光，并且可能发生转动的情况下，还是很不方便，在计算<strong>起始/结束点</strong>和激光 Sprite 的Scale 的关系时不太好计算（主要是 Sprite 只能通过 Scale 调整大小而不便指定 Rect 的 Size， 好像也可以,emmm）， 激光命中的粒子就随便弄一弄就好了。</p>
<h3 id="一些思考核问题">一些思考核问题</h3>
<p>在实现过程中遇到很多问题：</p>
<ol>
<li>被推动的箱子时主动移动还是被动移动?</li>
<li>箱子使用 KinamicBody 还是RigidBody（能够模拟下落，抛，旋转）?</li>
<li>箱子应该从内部移动还是外部移动?</li>
<li>是否需要设计里世界物体Mask？（例如，红箱子只能显示红色物体，绿箱子只能显示绿物体，其实应该有Mask，这样可以增加关卡设计的多样性）</li>
<li>是否应该设置里世界物体的显示时间？（可以增加该机制）</li>
<li>Godot.Collections.Array 不能存放 C# 接口，会报错，不知道是 Bug还是什么？</li>
<li>是否应该有其他多边形状的 Lens 和 里世界物体？ （应该有的）</li>
<li>Lens 的矩形是否应该有很多个进出口？（为了方便机制设计，应该有，所以一个Lens有很多个 PolyShape）</li>
<li>是否里世界物体应该高亮（应该的，为了区分里外物体，但是还没想好高亮应该怎么做？边缘发光，荧光，虚线还是整体发光？）</li>
<li>是否应该区分Lens 的可推动部分和不可推动部分？（应该，有利于复杂关卡设计）</li>
</ol>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-01-08</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" data-title="[游戏机制] 里世界-优化"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" data-title="[游戏机制] 里世界-优化"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" data-title="[游戏机制] 里世界-优化"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://blog.xuaii.cc/you-xi-ji-zhi-li-shi-jie-ji-zhi-you-hua/" data-title="[游戏机制] 里世界-优化" data-ralateuid="5661205446"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/you-xi-ji-zhi-chuang-ti-hu-dong/" class="prev" rel="prev" title="[游戏机制] 窗体互动"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>[游戏机制] 窗体互动</a>
            <a href="/you-xi-wai-gua-ai-zi-miao/" class="next" rel="next" title="[游戏外挂] 辅助瞄准系统">[游戏外挂] 辅助瞄准系统<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.109.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="blog.xuii.cc" target="_blank">_quijo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
